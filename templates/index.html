<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Такси Бот - Панель управления</title>
    <!-- Production Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .status-completed { color: #10b981; }
        .status-canceled { color: #ef4444; }
        .status-searching { color: #f59e0b; }
        .status-accepted { color: #06b6d4; }
        .status-waiting { color: #6b7280; }
        
        .chart-container {
            height: 300px;
        }
        
        .tab-active {
            border-bottom-color: #3b82f6;
            color: #2563eb;
            font-weight: 600;
        }
        
        .tab-inactive {
            border-bottom-color: transparent;
            color: #6b7280;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-center md:text-left mb-4 md:mb-0">
                    <h1 class="text-3xl md:text-4xl font-bold flex items-center justify-center md:justify-start gap-3">
                        <i data-lucide="car" class="w-8 h-8"></i>
                        Такси Бот - Панель управления
                    </h1>
                    <p class="text-blue-100 mt-2">Мониторинг статистики и управление пользователями</p>
                </div>
                <div class="auth-section flex items-center gap-4">
                    <div id="login-form" class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="username" placeholder="Логин" 
                               class="px-3 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               value="admin">
                        <input type="password" id="password" placeholder="Пароль" 
                               class="px-3 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               value="admin123">
                        <button onclick="login()" 
                                class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors flex items-center gap-2 justify-center">
                            <i data-lucide="log-in" class="w-4 h-4"></i>
                            Войти
                        </button>
                    </div>
                    <div id="user-info" class="hidden flex items-center gap-4">
                        <span class="text-white font-semibold flex items-center gap-2">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            Администратор
                        </span>
                        <button onclick="logout()" 
                                class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Выйти
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="flex overflow-x-auto">
                <button onclick="showTab('overview')" 
                        class="tab tab-active flex items-center gap-2 px-6 py-4 border-b-2 text-blue-600 font-semibold whitespace-nowrap">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    Обзор
                </button>
                <button onclick="showTab('drivers')" 
                        class="tab tab-inactive flex items-center gap-2 px-6 py-4 border-b-2 text-gray-600 hover:text-gray-900 font-medium whitespace-nowrap">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    Водители
                </button>
                <button onclick="showTab('orders')" 
                        class="tab tab-inactive flex items-center gap-2 px-6 py-4 border-b-2 text-gray-600 hover:text-gray-900 font-medium whitespace-nowrap">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                    Заказы
                </button>
                <button onclick="showTab('users')" 
                        class="tab tab-inactive flex items-center gap-2 px-6 py-4 border-b-2 text-gray-600 hover:text-gray-900 font-medium whitespace-nowrap">
                    <i data-lucide="user-cog" class="w-5 h-5"></i>
                    Пользователи
                </button>
                <button onclick="showTab('financial')" 
                        class="tab tab-inactive flex items-center gap-2 px-6 py-4 border-b-2 text-gray-600 hover:text-gray-900 font-medium whitespace-nowrap">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    Финансы
                </button>
                <button onclick="showTab('broadcast')" 
                        class="tab tab-inactive flex items-center gap-2 px-6 py-4 border-b-2 text-gray-600 hover:text-gray-900 font-medium whitespace-nowrap">
                    <i data-lucide="megaphone" class="w-5 h-5"></i>
                    Рассылка
                </button>
            </div>
        </div>

        <!-- Tab Contents -->
        
        <!-- Overview Tab -->
        <div id="overview" class="tab-content">
            <div id="overview-loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="text-gray-600 mt-4">Загрузка данных...</p>
            </div>
            <div id="overview-content" class="hidden">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Всего водителей</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="total-drivers">0</p>
                                <p class="text-sm text-gray-500 mt-1" id="active-drivers">0 активных</p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Всего заказов</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="total-orders">0</p>
                                <p class="text-sm text-gray-500 mt-1" id="completed-orders">0 выполнено</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg">
                                <i data-lucide="package" class="w-6 h-6 text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Общая выручка</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="total-earnings">0 ₽</p>
                                <p class="text-sm text-gray-500 mt-1" id="today-earnings">0 ₽ сегодня</p>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg">
                                <i data-lucide="dollar-sign" class="w-6 h-6 text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Пользователи</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2" id="total-users">0</p>
                                <p class="text-sm text-gray-500 mt-1" id="active-users">0 активных</p>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-lg">
                                <i data-lucide="user-plus" class="w-6 h-6 text-orange-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            Статистика заказов за последние 7 дней
                        </h2>
                        <div class="chart-container">
                            <canvas id="ordersChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i data-lucide="trending-up" class="w-5 h-5"></i>
                            Ежедневная выручка
                        </h2>
                        <div class="chart-container">
                            <canvas id="earningsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Drivers -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="award" class="w-5 h-5"></i>
                        Топ водители
                    </h2>
                    <div id="top-drivers-list"></div>
                </div>
            </div>
        </div>

        <!-- Drivers Tab -->
        <div id="drivers" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    Список водителей
                </h2>
                <div id="drivers-loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Загрузка данных о водителях...</p>
                </div>
                <div id="drivers-table" class="hidden overflow-x-auto">
                    <!-- Table will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="orders" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                    Управление заказами
                </h2>
                
                <div class="mb-6">
                    <button onclick="loadOpenOrders()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Обновить открытые заказы
                    </button>
                </div>
                
                <div id="open-orders-section" class="hidden mb-8">
                    <h3 class="text-md font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-500"></i>
                        Открытые заказы
                    </h3>
                    <div id="open-orders-table" class="overflow-x-auto"></div>
                </div>
                
                <div id="orders-loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Загрузка данных о заказах...</p>
                </div>
                <div id="orders-table" class="hidden overflow-x-auto">
                    <!-- Table will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                    <i data-lucide="user-cog" class="w-5 h-5"></i>
                    Управление пользователями
                </h2>
                <div id="users-loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Загрузка данных о пользователях...</p>
                </div>
                <div id="users-table" class="hidden overflow-x-auto">
                    <!-- Table will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Financial Tab -->
        <div id="financial" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    Финансовая статистика
                </h2>
                <div id="financial-loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Загрузка финансовых данных...</p>
                </div>
                <div id="financial-content" class="hidden">
                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Broadcast Tab -->
        <div id="broadcast" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                    <i data-lucide="megaphone" class="w-5 h-5"></i>
                    Массовая рассылка сообщений
                </h2>
                
                <!-- Статистика -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-blue-600">Всего пассажиров</p>
                                <p class="text-2xl font-bold text-blue-900 mt-1" id="total-passengers">0</p>
                            </div>
                            <i data-lucide="users" class="w-8 h-8 text-blue-400"></i>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-green-600">Всего водителей</p>
                                <p class="text-2xl font-bold text-green-900 mt-1" id="total-drivers-broadcast">0</p>
                            </div>
                            <i data-lucide="user-check" class="w-8 h-8 text-green-400"></i>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-purple-600">Активных пользователей</p>
                                <p class="text-2xl font-bold text-purple-900 mt-1" id="total-active-users">0</p>
                            </div>
                            <i data-lucide="activity" class="w-8 h-8 text-purple-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Форма рассылки -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Настройки рассылки</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Выбор получателей -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Получатели:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="select-all-passengers" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Все пассажиры</span>
                                    <span class="ml-2 text-xs text-gray-500" id="passengers-count">(0)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="select-all-drivers" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Все водители</span>
                                    <span class="ml-2 text-xs text-gray-500" id="drivers-count">(0)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="only-active-users" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                    <span class="ml-2 text-sm text-gray-700">Только активные (не заблокированные)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Статистика выбора -->
                        <div class="bg-white rounded-lg p-4 border border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">Статистика рассылки:</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Всего выбрано:</span>
                                    <span class="font-semibold" id="total-selected">0 пользователей</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Пассажиров:</span>
                                    <span class="font-semibold text-blue-600" id="selected-passengers">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Водителей:</span>
                                    <span class="font-semibold text-green-600" id="selected-drivers">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Текст сообщения -->
                    <div class="mb-6">
                        <label for="messageText" class="block text-sm font-medium text-gray-700 mb-2">
                            Текст сообщения *
                        </label>
                        <textarea id="messageText" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  rows="6" 
                                  placeholder="Введите текст сообщения для рассылки..."
                                  maxlength="4000"></textarea>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Максимум 4000 символов</span>
                            <span id="charCount">0/4000</span>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="previewMessage()" 
                                class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors flex items-center gap-2 justify-center">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                            Предпросмотр
                        </button>
                        <button onclick="sendBroadcastMessage()" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2 justify-center">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Отправить рассылку
                        </button>
                    </div>
                </div>

                <!-- История рассылок -->
                <div class="bg-white rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <i data-lucide="history" class="w-5 h-5"></i>
                            История рассылок
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="broadcast-history" class="text-center text-gray-500">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p>История рассылок будет отображаться здесь</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Ban User Modal -->
    <div id="banModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i data-lucide="ban" class="w-6 h-6 text-red-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Заблокировать пользователя</h3>
                </div>
                <form id="banForm">
                    <input type="hidden" id="banUserId">
                    <div class="space-y-4">
                        <div>
                            <label for="banReason" class="block text-sm font-medium text-gray-700 mb-2">
                                Причина блокировки
                            </label>
                            <textarea id="banReason" placeholder="Введите причину блокировки..." 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      required rows="3"></textarea>
                        </div>
                        <div>
                            <label for="banDuration" class="block text-sm font-medium text-gray-700 mb-2">
                                Срок блокировки (дней)
                            </label>
                            <input type="number" id="banDuration" value="1" min="1" max="365" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   required>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeModal('banModal')" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                            Отмена
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
                            Заблокировать
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Unban User Modal -->
    <div id="unbanModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i data-lucide="user-check" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Разблокировать пользователя</h3>
                </div>
                <p class="text-gray-600 mb-6">Вы уверены, что хотите разблокировать пользователя <span id="unbanUserName" class="font-semibold"></span>?</p>
                <input type="hidden" id="unbanUserId">
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('unbanModal')" 
                            class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Отмена
                    </button>
                    <button type="button" onclick="confirmUnban()" 
                            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">
                        Разблокировать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Driver Modal -->
    <div id="createDriverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i data-lucide="user-plus" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Создать водителя</h3>
                </div>
                <form id="createDriverForm">
                    <input type="hidden" id="createDriverUserId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="driverName" class="block text-sm font-medium text-gray-700 mb-2">
                                ФИО водителя *
                            </label>
                            <input type="text" id="driverName" placeholder="Введите ФИО..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   required>
                        </div>
                        <div>
                            <label for="carBrand" class="block text-sm font-medium text-gray-700 mb-2">
                                Марка автомобиля *
                            </label>
                            <input type="text" id="carBrand" placeholder="Например: Toyota" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   required>
                        </div>
                        <div>
                            <label for="carModel" class="block text-sm font-medium text-gray-700 mb-2">
                                Модель автомобиля *
                            </label>
                            <input type="text" id="carModel" placeholder="Например: Camry" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   required>
                        </div>
                        <div>
                            <label for="licensePlate" class="block text-sm font-medium text-gray-700 mb-2">
                                Госномер *
                            </label>
                            <input type="text" id="licensePlate" placeholder="Например: A123BC777" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   required>
                        </div>
                        <div>
                            <label for="carColor" class="block text-sm font-medium text-gray-700 mb-2">
                                Цвет автомобиля *
                            </label>
                            <input type="text" id="carColor" placeholder="Например: Черный" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   required>
                        </div>
                        <div>
                            <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-2">
                                Контактный телефон *
                            </label>
                            <input type="text" id="contactPhone" placeholder="+79991234567" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   required>
                        </div>
                        <div>
                            <label for="paymentPhone" class="block text-sm font-medium text-gray-700 mb-2">
                                Телефон для выплат
                            </label>
                            <input type="text" id="paymentPhone" placeholder="+79991234567" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="bankBank" class="block text-sm font-medium text-gray-700 mb-2">
                                Банк
                            </label>
                            <input type="text" id="bankBank" placeholder="Например: Сбербанк" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeModal('createDriverModal')" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                            Отмена
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                            Создать водителя
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Remove Driver Modal -->
    <div id="removeDriverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-orange-100 rounded-lg">
                        <i data-lucide="user-minus" class="w-6 h-6 text-orange-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Удалить водителя</h3>
                </div>
                <p class="text-gray-600 mb-2">Вы уверены, что хотите удалить водителя <span id="removeDriverName" class="font-semibold"></span>?</p>
                <p class="text-sm text-gray-500 mb-6">Пользователь вернется в статус обычного пользователя.</p>
                <input type="hidden" id="removeDriverUserId">
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('removeDriverModal')" 
                            class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Отмена
                    </button>
                    <button type="button" onclick="confirmRemoveDriver()" 
                            class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 transition-colors">
                        Удалить водителя
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Driver Modal -->
    <div id="assignDriverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i data-lucide="user-check" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Назначить водителя</h3>
                </div>
                <form id="assignDriverForm">
                    <input type="hidden" id="assignOrderId">
                    <div class="mb-6">
                        <label for="driverSelect" class="block text-sm font-medium text-gray-700 mb-2">
                            Выберите водителя
                        </label>
                        <select id="driverSelect" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required>
                            <option value="">-- Выберите водителя --</option>
                        </select>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal('assignDriverModal')" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                            Отмена
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">
                            Назначить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Driver Modal -->
    <div id="viewDriverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i data-lucide="user" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Данные водителя</h3>
                </div>
                <div id="driverDetailsContent"></div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="closeModal('viewDriverModal')" 
                            class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Passenger Modal -->
    <div id="viewPassengerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i data-lucide="user" class="w-6 h-6 text-purple-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Данные пассажира</h3>
                </div>
                <div id="passengerDetailsContent"></div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="closeModal('viewPassengerModal')" 
                            class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Order Modal -->
    <div id="cancelOrderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Отменить заказ</h3>
                </div>
                <form id="cancelOrderForm">
                    <input type="hidden" id="cancelOrderId">
                    <div class="mb-6">
                        <label for="cancelReason" class="block text-sm font-medium text-gray-700 mb-2">
                            Причина отмены
                        </label>
                        <textarea id="cancelReason" placeholder="Введите причину отмены..." 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  required rows="3"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal('cancelOrderModal')" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                            Отмена
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
                            Отменить заказ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Preview Message Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i data-lucide="eye" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Предпросмотр сообщения</h3>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-sm text-gray-600 mb-2">Получатели:</div>
                    <div id="preview-recipients" class="text-sm text-gray-800"></div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                    <div class="text-sm text-gray-600 mb-2">Текст сообщения:</div>
                    <div id="preview-message" class="text-gray-800 whitespace-pre-wrap"></div>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('previewModal')" 
                            class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Назад к редактированию
                    </button>
                    <button type="button" onclick="confirmSendMessage()" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        let currentUser = null;
        let charts = {};
        let availableDrivers = [];
        
        // Broadcast variables
        let allPassengers = [];
        let allDrivers = [];
        let broadcastHistory = [];

        // Authentication functions
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Initialize event listeners for broadcast
            document.getElementById('messageText').addEventListener('input', updateCharCount);
            document.getElementById('select-all-passengers').addEventListener('change', updateSelectionStats);
            document.getElementById('select-all-drivers').addEventListener('change', updateSelectionStats);
            document.getElementById('only-active-users').addEventListener('change', updateSelectionStats);
        });

        async function checkAuth() {
            try {
                const response = await axios.get('/check_auth');
                if (response.data.logged_in) {
                    showAuthenticated();
                    loadOverviewData();
                } else {
                    showLoginForm();
                }
            } catch (error) {
                showLoginForm();
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await axios.post('/login', {
                    username: username,
                    password: password
                });

                if (response.data.success) {
                    showAuthenticated();
                    loadOverviewData();
                    showAlert('Успешный вход!', 'success');
                }
            } catch (error) {
                showAlert('Неверные учетные данные!', 'error');
            }
        }

        async function logout() {
            try {
                await axios.get('/logout');
                showLoginForm();
                showAlert('Выход выполнен!', 'success');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('user-info').classList.add('hidden');
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        }

        function showAuthenticated() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
        }

        // Tab functions
        function showTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('tab-inactive');
            });
            
            // Activate current tab
            const activeTab = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
            activeTab.classList.remove('tab-inactive');
            activeTab.classList.add('tab-active');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show current tab content
            document.getElementById(tabName).classList.remove('hidden');

            // Load data for tab
            switch(tabName) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'drivers':
                    loadDriversData();
                    break;
                case 'orders':
                    loadOrdersData();
                    break;
                case 'users':
                    loadUsersData();
                    break;
                case 'financial':
                    loadFinancialData();
                    break;
                case 'broadcast':
                    loadBroadcastData();
                    break;
            }
        }

        // Data loading functions
        async function loadOverviewData() {
            try {
                const response = await axios.get('/api/dashboard');
                const data = response.data;
                
                // Update stats
                document.getElementById('total-drivers').textContent = data.drivers.length;
                document.getElementById('active-drivers').textContent = 
                    data.drivers.filter(d => !d.is_banned).length + ' активных';
                
                document.getElementById('total-orders').textContent = data.orders.total_stats.total_orders;
                document.getElementById('completed-orders').textContent = 
                    data.orders.total_stats.completed_orders + ' выполнено';
                
                document.getElementById('total-earnings').textContent = 
                    formatCurrency(data.orders.total_stats.total_earnings);
                document.getElementById('today-earnings').textContent = 
                    formatCurrency(data.drivers.reduce((sum, driver) => sum + driver.today_earnings, 0)) + ' сегодня';
                
                // Update user stats
                const totalUsers = Object.values(data.users.role_stats).reduce((sum, role) => sum + role.total, 0);
                const activeUsers = Object.values(data.users.active_users).reduce((sum, count) => sum + count, 0);
                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('active-users').textContent = activeUsers + ' активных';
                
                // Create charts
                createOrdersChart(data.orders.daily_stats);
                createEarningsChart(data.financial.daily_earnings);
                
                // Show top drivers
                showTopDrivers(data.financial.top_drivers);
                
                document.getElementById('overview-loading').classList.add('hidden');
                document.getElementById('overview-content').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading overview data:', error);
                document.getElementById('overview-loading').innerHTML = 
                    '<p class="text-red-600">Ошибка загрузки данных</p>';
            }
        }

        async function loadDriversData() {
            try {
                const response = await axios.get('/api/drivers');
                const drivers = response.data;
                
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Автомобиль</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Заказы</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Выручка</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                drivers.forEach(driver => {
                    const statusClass = driver.is_banned ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
                    const statusText = driver.is_banned ? 'Заблокирован' : 'Активен';
                    const successRate = driver.total_orders > 0 ? 
                        Math.round((driver.completed_orders / driver.total_orders) * 100) : 0;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driver.user_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${driver.name || driver.first_name || 'Не указано'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${driver.car_brand} ${driver.car_model} (${driver.license_plate})</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driver.completed_orders}/${driver.total_orders} (${successRate}%)</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(driver.total_earnings)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="viewDriverDetails(${driver.user_id})" 
                                            class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200 transition-colors">
                                        <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                                        Просмотр
                                    </button>
                                    ${driver.is_banned ? 
                                        `<button onclick="openUnbanModal(${driver.user_id}, '${driver.name || driver.first_name || 'Пользователь'}')" 
                                                class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200 transition-colors">
                                            <i data-lucide="user-check" class="w-3 h-3 mr-1"></i>
                                            Разблокировать
                                        </button>` :
                                        `<button onclick="openBanModal(${driver.user_id})" 
                                                class="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200 transition-colors">
                                            <i data-lucide="ban" class="w-3 h-3 mr-1"></i>
                                            Заблокировать
                                        </button>`
                                    }
                                    <button onclick="openRemoveDriverModal(${driver.user_id}, '${driver.name || driver.first_name || 'Водитель'}')" 
                                            class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors">
                                        <i data-lucide="user-minus" class="w-3 h-3 mr-1"></i>
                                        Удалить
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `</tbody></table>`;
                
                document.getElementById('drivers-table').innerHTML = tableHTML;
                document.getElementById('drivers-loading').classList.add('hidden');
                document.getElementById('drivers-table').classList.remove('hidden');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading drivers data:', error);
                document.getElementById('drivers-loading').innerHTML = '<p class="text-red-600">Ошибка загрузки данных</p>';
            }
        }

        async function loadOrdersData() {
            try {
                const response = await axios.get('/api/orders');
                const data = response.data;
                
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пассажир</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Водитель</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Маршрут</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Стоимость</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата создания</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                data.recent_orders.forEach(order => {
                    const statusClass = `status-${order.status}`;
                    const statusText = getStatusText(order.status);
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.order_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="viewPassengerDetails(${order.passenger_id})" 
                                        class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200 transition-colors">
                                    <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                                    ${order.passenger_name || order.passenger_id}
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                ${order.driver_id ? 
                                    `<button onclick="viewDriverDetails(${order.driver_id})" 
                                            class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200 transition-colors">
                                        <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                                        ${order.driver_name || order.driver_id}
                                    </button>` : 
                                    'Не назначен'
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.from_location} → ${order.to_location}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(order.price)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateTime(order.created_at)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex flex-wrap gap-1">
                                    ${(order.status === 'searching' || order.status === 'accepted') ? 
                                        `<button onclick="openCancelOrderModal(${order.order_id})" 
                                                class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs hover:bg-orange-200 transition-colors">
                                            <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i>
                                            Отменить
                                        </button>` : 
                                        ''
                                    }
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `</tbody></table>`;
                
                document.getElementById('orders-table').innerHTML = tableHTML;
                document.getElementById('orders-loading').classList.add('hidden');
                document.getElementById('orders-table').classList.remove('hidden');
                
                // Load open orders
                loadOpenOrders();
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading orders data:', error);
                document.getElementById('orders-loading').innerHTML = '<p class="text-red-600">Ошибка загрузки данных</p>';
            }
        }

        async function loadOpenOrders() {
            try {
                const response = await axios.get('/api/orders');
                const data = response.data;
                
                const openOrders = data.recent_orders.filter(order => 
                    order.status === 'searching' || order.status === 'accepted'
                );
                
                if (openOrders.length === 0) {
                    document.getElementById('open-orders-section').classList.add('hidden');
                    return;
                }
                
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пассажир</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Маршрут</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Стоимость</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата создания</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                openOrders.forEach(order => {
                    const statusClass = `status-${order.status}`;
                    const statusText = getStatusText(order.status);
                    const rowClass = order.status === 'searching' ? 'bg-yellow-50' : 'bg-blue-50';
                    
                    tableHTML += `
                        <tr class="${rowClass} hover:bg-opacity-80">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.order_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="viewPassengerDetails(${order.passenger_id})" 
                                        class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200 transition-colors">
                                    <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                                    ${order.passenger_name || order.passenger_id}
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.from_location} → ${order.to_location}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(order.price)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateTime(order.created_at)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex flex-wrap gap-1">
                                    ${order.status === 'searching' ? 
                                        `<button onclick="openAssignDriverModal(${order.order_id})" 
                                                class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200 transition-colors">
                                            <i data-lucide="user-check" class="w-3 h-3 mr-1"></i>
                                            Назначить
                                        </button>` : 
                                        ''
                                    }
                                    <button onclick="openCancelOrderModal(${order.order_id})" 
                                            class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs hover:bg-orange-200 transition-colors">
                                        <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i>
                                        Отменить
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `</tbody></table>`;
                
                document.getElementById('open-orders-table').innerHTML = tableHTML;
                document.getElementById('open-orders-section').classList.remove('hidden');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading open orders:', error);
            }
        }

        async function loadUsersData() {
            try {
                const response = await axios.get('/api/admin/users');
                const users = response.data;
                
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Роль</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата регистрации</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                users.forEach(user => {
                    const statusClass = user.is_banned ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
                    const statusText = user.is_banned ? 'Заблокирован' : 'Активен';
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.user_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@${user.username || 'не указан'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.first_name || 'Не указано'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getRoleText(user.role)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateTime(user.registration_date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="viewUserDetails(${user.user_id})" 
                                            class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs hover:bg-purple-200 transition-colors">
                                        <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                                        Просмотр
                                    </button>
                                    ${user.is_banned ? 
                                        `<button onclick="openUnbanModal(${user.user_id}, '${user.first_name || user.username || 'Пользователь'}')" 
                                                class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200 transition-colors">
                                            <i data-lucide="user-check" class="w-3 h-3 mr-1"></i>
                                            Разблокировать
                                        </button>` :
                                        `<button onclick="openBanModal(${user.user_id})" 
                                                class="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200 transition-colors">
                                            <i data-lucide="ban" class="w-3 h-3 mr-1"></i>
                                            Заблокировать
                                        </button>`
                                    }
                                    ${user.role !== 'driver' ? 
                                        `<button onclick="openCreateDriverModal(${user.user_id})" 
                                                class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200 transition-colors">
                                            <i data-lucide="user-plus" class="w-3 h-3 mr-1"></i>
                                            Сделать водителем
                                        </button>` :
                                        `<button onclick="openRemoveDriverModal(${user.user_id}, '${user.first_name || user.username || 'Водитель'}')" 
                                                class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200 transition-colors">
                                            <i data-lucide="user-minus" class="w-3 h-3 mr-1"></i>
                                            Удалить водителя
                                        </button>`
                                    }
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `</tbody></table>`;
                
                document.getElementById('users-table').innerHTML = tableHTML;
                document.getElementById('users-loading').classList.add('hidden');
                document.getElementById('users-table').classList.remove('hidden');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading users data:', error);
                document.getElementById('users-loading').innerHTML = '<p class="text-red-600">Ошибка загрузки данных</p>';
            }
        }

        async function loadFinancialData() {
            try {
                const response = await axios.get('/api/financial');
                const data = response.data;
                
                createFinancialChart(data.daily_earnings);
                
                document.getElementById('financial-loading').classList.add('hidden');
                document.getElementById('financial-content').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading financial data:', error);
                document.getElementById('financial-loading').innerHTML = '<p class="text-red-600">Ошибка загрузки данных</p>';
            }
        }

        // Broadcast functions
        async function loadBroadcastData() {
            try {
                // Load passengers data
                const passengersResponse = await axios.get('/api/admin/passengers');
                allPassengers = passengersResponse.data;
                
                // Load drivers data
                const driversResponse = await axios.get('/api/admin/drivers_for_messaging');
                allDrivers = driversResponse.data;
                
                // Update statistics
                updateBroadcastStats();
                
            } catch (error) {
                console.error('Error loading broadcast data:', error);
                showAlert('Ошибка загрузки данных для рассылки', 'error');
            }
        }

        function updateBroadcastStats() {
            const activePassengers = allPassengers.filter(p => !p.is_banned).length;
            const activeDrivers = allDrivers.filter(d => !d.is_banned).length;
            const totalActive = activePassengers + activeDrivers;
            
            document.getElementById('total-passengers').textContent = allPassengers.length;
            document.getElementById('total-drivers-broadcast').textContent = allDrivers.length;
            document.getElementById('total-active-users').textContent = totalActive;
            
            document.getElementById('passengers-count').textContent = `(${allPassengers.length})`;
            document.getElementById('drivers-count').textContent = `(${allDrivers.length})`;
            
            updateSelectionStats();
        }

        function updateSelectionStats() {
            const selectPassengers = document.getElementById('select-all-passengers').checked;
            const selectDrivers = document.getElementById('select-all-drivers').checked;
            const onlyActive = document.getElementById('only-active-users').checked;
            
            let selectedPassengers = 0;
            let selectedDrivers = 0;
            
            if (selectPassengers) {
                selectedPassengers = onlyActive ? 
                    allPassengers.filter(p => !p.is_banned).length : 
                    allPassengers.length;
            }
            
            if (selectDrivers) {
                selectedDrivers = onlyActive ? 
                    allDrivers.filter(d => !d.is_banned).length : 
                    allDrivers.length;
            }
            
            const totalSelected = selectedPassengers + selectedDrivers;
            
            document.getElementById('total-selected').textContent = `${totalSelected} пользователей`;
            document.getElementById('selected-passengers').textContent = selectedPassengers;
            document.getElementById('selected-drivers').textContent = selectedDrivers;
        }

        function getSelectedUserIds() {
            const selectPassengers = document.getElementById('select-all-passengers').checked;
            const selectDrivers = document.getElementById('select-all-drivers').checked;
            const onlyActive = document.getElementById('only-active-users').checked;
            
            let userIds = [];
            
            if (selectPassengers) {
                const passengers = onlyActive ? 
                    allPassengers.filter(p => !p.is_banned) : 
                    allPassengers;
                userIds.push(...passengers.map(p => p.user_id));
            }
            
            if (selectDrivers) {
                const drivers = onlyActive ? 
                    allDrivers.filter(d => !d.is_banned) : 
                    allDrivers;
                userIds.push(...drivers.map(d => d.user_id));
            }
            
            return userIds;
        }

        function previewMessage() {
            const messageText = document.getElementById('messageText').value.trim();
            const userIds = getSelectedUserIds();
            
            if (userIds.length === 0) {
                showAlert('Выберите получателей сообщения', 'error');
                return;
            }
            
            if (!messageText) {
                showAlert('Введите текст сообщения', 'error');
                return;
            }
            
            // Update preview
            const selectPassengers = document.getElementById('select-all-passengers').checked;
            const selectDrivers = document.getElementById('select-all-drivers').checked;
            const onlyActive = document.getElementById('only-active-users').checked;
            
            let recipientsText = '';
            if (selectPassengers && selectDrivers) {
                recipientsText = `Все ${onlyActive ? 'активные ' : ''}пользователи (пассажиры и водители)`;
            } else if (selectPassengers) {
                recipientsText = `Все ${onlyActive ? 'активные ' : ''}пассажиры`;
            } else if (selectDrivers) {
                recipientsText = `Все ${onlyActive ? 'активные ' : ''}водители`;
            }
            
            recipientsText += ` (${userIds.length} пользователей)`;
            
            document.getElementById('preview-recipients').textContent = recipientsText;
            document.getElementById('preview-message').textContent = messageText;
            
            // Show modal
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function confirmSendMessage() {
            const messageText = document.getElementById('messageText').value.trim();
            const userIds = getSelectedUserIds();
            
            sendBroadcastMessage(userIds, messageText);
            closeModal('previewModal');
        }

        async function sendBroadcastMessage(userIds = null, messageText = null) {
            if (!userIds || !messageText) {
                userIds = getSelectedUserIds();
                messageText = document.getElementById('messageText').value.trim();
            }
            
            if (userIds.length === 0) {
                showAlert('Выберите получателей сообщения', 'error');
                return;
            }
            
            if (!messageText) {
                showAlert('Введите текст сообщения', 'error');
                return;
            }
            
            // Confirmation for large broadcasts
            if (userIds.length > 100) {
                const confirmed = confirm(`Вы собираетесь отправить сообщение ${userIds.length} пользователям. Продолжить?`);
                if (!confirmed) return;
            }
            
            try {
                const response = await axios.post('/api/admin/send_message', {
                    user_ids: userIds,
                    message_text: messageText,
                    message_type: 'broadcast'
                });
                
                if (response.data.success) {
                    showAlert(response.data.message, 'success');
                    
                    // Add to history
                    addToBroadcastHistory({
                        timestamp: new Date().toISOString(),
                        recipients: userIds.length,
                        message: messageText,
                        type: 'broadcast'
                    });
                    
                    // Clear form
                    document.getElementById('messageText').value = '';
                    updateCharCount();
                    
                } else {
                    showAlert(response.data.message, 'error');
                }
            } catch (error) {
                console.error('Error sending broadcast message:', error);
                showAlert('Ошибка при отправке рассылки', 'error');
            }
        }

        function addToBroadcastHistory(message) {
            broadcastHistory.unshift(message);
            if (broadcastHistory.length > 10) {
                broadcastHistory = broadcastHistory.slice(0, 10);
            }
            updateBroadcastHistory();
        }

        function updateBroadcastHistory() {
            const historyContainer = document.getElementById('broadcast-history');
            
            if (broadcastHistory.length === 0) {
                historyContainer.innerHTML = `
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                    <p>История рассылок будет отображаться здесь</p>
                `;
                lucide.createIcons();
                return;
            }
            
            let html = '<div class="space-y-4">';
            
            broadcastHistory.forEach((item, index) => {
                const date = new Date(item.timestamp);
                const timeString = date.toLocaleString('ru-RU');
                
                html += `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-medium text-gray-900">Рассылка #${broadcastHistory.length - index}</span>
                            <span class="text-xs text-gray-500">${timeString}</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            Получателей: <span class="font-semibold">${item.recipients}</span>
                        </div>
                        <div class="text-sm text-gray-700 bg-white p-3 rounded border">
                            ${item.message}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            historyContainer.innerHTML = html;
        }

        function updateCharCount() {
            const textarea = document.getElementById('messageText');
            const charCount = document.getElementById('charCount');
            const count = textarea.value.length;
            
            charCount.textContent = `${count}/4000`;
            
            if (count > 3800) {
                charCount.classList.add('text-red-600');
            } else {
                charCount.classList.remove('text-red-600');
            }
        }

        // Chart functions
        function createOrdersChart(dailyStats) {
            const ctx = document.getElementById('ordersChart').getContext('2d');
            
            if (charts.ordersChart) {
                charts.ordersChart.destroy();
            }
            
            const labels = dailyStats.map(stat => {
                const date = new Date(stat.date);
                return date.toLocaleDateString('ru-RU');
            }).reverse();
            
            const completedData = dailyStats.map(stat => stat.completed_orders).reverse();
            const canceledData = dailyStats.map(stat => stat.canceled_orders).reverse();
            const totalData = dailyStats.map(stat => stat.total_orders).reverse();
            
            charts.ordersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Всего заказов',
                            data: totalData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Выполненные',
                            data: completedData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Отмененные',
                            data: canceledData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function createEarningsChart(dailyEarnings) {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            
            if (charts.earningsChart) {
                charts.earningsChart.destroy();
            }
            
            const labels = dailyEarnings.map(stat => {
                const date = new Date(stat.date);
                return date.toLocaleDateString('ru-RU');
            }).reverse();
            
            const earningsData = dailyEarnings.map(stat => stat.earnings).reverse();
            
            charts.earningsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Выручка (₽)',
                        data: earningsData,
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createFinancialChart(dailyEarnings) {
            const ctx = document.getElementById('financialChart').getContext('2d');
            
            if (charts.financialChart) {
                charts.financialChart.destroy();
            }
            
            const labels = dailyEarnings.map(stat => {
                const date = new Date(stat.date);
                return date.toLocaleDateString('ru-RU');
            }).reverse();
            
            const earningsData = dailyEarnings.map(stat => stat.earnings).reverse();
            const ordersData = dailyEarnings.map(stat => stat.completed_orders).reverse();
            
            charts.financialChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Выручка (₽)',
                            data: earningsData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Завершенные заказы',
                            data: ordersData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value).replace('₽', '') + ' ₽';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Modal functions
        function openBanModal(userId) {
            document.getElementById('banUserId').value = userId;
            document.getElementById('banReason').value = '';
            document.getElementById('banDuration').value = 1;
            document.getElementById('banModal').classList.remove('hidden');
        }

        function openUnbanModal(userId, userName) {
            document.getElementById('unbanUserId').value = userId;
            document.getElementById('unbanUserName').textContent = userName;
            document.getElementById('unbanModal').classList.remove('hidden');
        }

        function openCreateDriverModal(userId) {
            document.getElementById('createDriverUserId').value = userId;
            // Reset form fields
            ['driverName', 'carBrand', 'carModel', 'licensePlate', 'carColor', 'contactPhone', 'paymentPhone', 'bankBank']
                .forEach(field => document.getElementById(field).value = '');
            document.getElementById('createDriverModal').classList.remove('hidden');
        }

        function openRemoveDriverModal(userId, driverName) {
            document.getElementById('removeDriverUserId').value = userId;
            document.getElementById('removeDriverName').textContent = driverName;
            document.getElementById('removeDriverModal').classList.remove('hidden');
        }

        async function openAssignDriverModal(orderId) {
            try {
                const response = await axios.get('/api/drivers');
                const drivers = response.data.filter(driver => !driver.is_banned);
                
                const driverSelect = document.getElementById('driverSelect');
                driverSelect.innerHTML = '<option value="">-- Выберите водителя --</option>';
                
                drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.user_id;
                    option.textContent = `${driver.name || driver.first_name} - ${driver.car_brand} ${driver.car_model} (${driver.license_plate})`;
                    driverSelect.appendChild(option);
                });
                
                document.getElementById('assignOrderId').value = orderId;
                document.getElementById('assignDriverModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading drivers for assignment:', error);
                showAlert('Ошибка загрузки списка водителей', 'error');
            }
        }

        function openCancelOrderModal(orderId) {
            document.getElementById('cancelOrderId').value = orderId;
            document.getElementById('cancelReason').value = '';
            document.getElementById('cancelOrderModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Form handlers
        document.getElementById('banForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('banUserId').value;
            const reason = document.getElementById('banReason').value;
            const duration = document.getElementById('banDuration').value;
            
            try {
                const response = await axios.post('/api/admin/ban', {
                    user_id: userId,
                    reason: reason,
                    duration_days: parseInt(duration)
                });
                
                if (response.data.success) {
                    showAlert('Пользователь успешно заблокирован!', 'success');
                    closeModal('banModal');
                    // Refresh data
                    if (document.getElementById('users').classList.contains('hidden') === false) {
                        loadUsersData();
                    }
                    if (document.getElementById('drivers').classList.contains('hidden') === false) {
                        loadDriversData();
                    }
                }
            } catch (error) {
                showAlert('Ошибка при блокировке пользователя!', 'error');
            }
        });

        async function confirmUnban() {
            const userId = document.getElementById('unbanUserId').value;
            
            try {
                const response = await axios.post('/api/admin/unban', {
                    user_id: userId
                });
                
                if (response.data.success) {
                    showAlert('Пользователь успешно разблокирован!', 'success');
                    closeModal('unbanModal');
                    // Refresh data
                    if (document.getElementById('users').classList.contains('hidden') === false) {
                        loadUsersData();
                    }
                    if (document.getElementById('drivers').classList.contains('hidden') === false) {
                        loadDriversData();
                    }
                }
            } catch (error) {
                showAlert('Ошибка при разблокировке пользователя!', 'error');
            }
        }

        document.getElementById('createDriverForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('createDriverUserId').value;
            const driverData = {
                name: document.getElementById('driverName').value,
                car_brand: document.getElementById('carBrand').value,
                car_model: document.getElementById('carModel').value,
                license_plate: document.getElementById('licensePlate').value,
                car_color: document.getElementById('carColor').value,
                contact_phone: document.getElementById('contactPhone').value,
                payment_phone: document.getElementById('paymentPhone').value,
                bank: document.getElementById('bankBank').value
            };
            
            try {
                const response = await axios.post('/api/admin/create_driver', {
                    user_id: userId,
                    driver_data: driverData
                });
                
                if (response.data.success) {
                    showAlert('Водитель успешно создан!', 'success');
                    closeModal('createDriverModal');
                    // Refresh data
                    if (document.getElementById('users').classList.contains('hidden') === false) {
                        loadUsersData();
                    }
                    if (document.getElementById('drivers').classList.contains('hidden') === false) {
                        loadDriversData();
                    }
                } else {
                    showAlert(response.data.message, 'error');
                }
            } catch (error) {
                showAlert('Ошибка при создании водителя!', 'error');
            }
        });

        async function confirmRemoveDriver() {
            const userId = document.getElementById('removeDriverUserId').value;
            
            try {
                const response = await axios.post('/api/admin/delete_driver', {
                    user_id: userId
                });
                
                if (response.data.success) {
                    showAlert('Водитель успешно удален!', 'success');
                    closeModal('removeDriverModal');
                    // Refresh data
                    if (document.getElementById('users').classList.contains('hidden') === false) {
                        loadUsersData();
                    }
                    if (document.getElementById('drivers').classList.contains('hidden') === false) {
                        loadDriversData();
                    }
                } else {
                    showAlert(response.data.message, 'error');
                }
            } catch (error) {
                showAlert('Ошибка при удалении водителя!', 'error');
            }
        }

        document.getElementById('assignDriverForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const orderId = document.getElementById('assignOrderId').value;
            const driverId = document.getElementById('driverSelect').value;
            
            try {
                const response = await axios.post('/api/admin/assign_driver', {
                    order_id: orderId,
                    driver_id: parseInt(driverId)
                });
                
                if (response.data.success) {
                    showAlert('Водитель успешно назначен!', 'success');
                    closeModal('assignDriverModal');
                    // Refresh orders data
                    loadOrdersData();
                } else {
                    showAlert(response.data.message, 'error');
                }
            } catch (error) {
                showAlert('Ошибка при назначении водителя!', 'error');
            }
        });

        document.getElementById('cancelOrderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const orderId = document.getElementById('cancelOrderId').value;
            const reason = document.getElementById('cancelReason').value;
            
            try {
                const response = await axios.post('/api/admin/cancel_order', {
                    order_id: orderId,
                    reason: reason
                });
                
                if (response.data.success) {
                    showAlert('Заказ успешно отменен!', 'success');
                    closeModal('cancelOrderModal');
                    // Refresh orders data
                    loadOrdersData();
                } else {
                    showAlert(response.data.message, 'error');
                }
            } catch (error) {
                showAlert('Ошибка при отмене заказа!', 'error');
            }
        });

        // View details functions
        async function viewDriverDetails(userId) {
            try {
                const response = await axios.get(`/api/admin/driver/${userId}`);
                const driver = response.data;
                
                if (!driver) {
                    showAlert('Водитель не найден!', 'error');
                    return;
                }
                
                const successRate = driver.total_orders > 0 ? 
                    Math.round((driver.completed_orders / driver.total_orders) * 100) : 0;
                
                let html = `
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">ID пользователя:</span>
                                    <span class="text-sm text-gray-900">${driver.user_id}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">ФИО:</span>
                                    <span class="text-sm text-gray-900">${driver.name || 'Не указано'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Username:</span>
                                    <span class="text-sm text-gray-900">@${driver.username || 'не указан'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Имя в Telegram:</span>
                                    <span class="text-sm text-gray-900">${driver.first_name || 'Не указано'}</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Статус:</span>
                                    <span class="text-sm ${driver.is_banned ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold'}">
                                        ${driver.is_banned ? 'Заблокирован' : 'Активен'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Дата регистрации:</span>
                                    <span class="text-sm text-gray-900">${formatDateTime(driver.registration_date)}</span>
                                </div>
                                ${driver.is_banned ? `
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Причина блокировки:</span>
                                    <span class="text-sm text-gray-900">${driver.ban_reason || 'Не указана'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Блокировка до:</span>
                                    <span class="text-sm text-gray-900">${driver.ban_until ? formatDateTime(driver.ban_until) : 'Не указано'}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Автомобиль</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Марка:</span>
                                <span class="text-sm text-gray-900">${driver.car_brand}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Модель:</span>
                                <span class="text-sm text-gray-900">${driver.car_model}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Госномер:</span>
                                <span class="text-sm text-gray-900">${driver.license_plate}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Цвет:</span>
                                <span class="text-sm text-gray-900">${driver.car_color || 'Не указан'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Контактная информация</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Контактный телефон:</span>
                                <span class="text-sm text-gray-900">${driver.contact_phone || 'Не указан'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Телефон для выплат:</span>
                                <span class="text-sm text-gray-900">${driver.payment_phone || 'Не указан'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Банк:</span>
                                <span class="text-sm text-gray-900">${driver.bank || 'Не указан'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Статистика</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-blue-600">${driver.total_orders}</div>
                                <div class="text-sm text-gray-500">Всего заказов</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-green-600">${driver.completed_orders}</div>
                                <div class="text-sm text-gray-500">Выполнено</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-red-600">${driver.canceled_orders}</div>
                                <div class="text-sm text-gray-500">Отменено</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-purple-600">${successRate}%</div>
                                <div class="text-sm text-gray-500">Успешность</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Общая выручка:</span>
                                <span class="text-sm font-semibold text-gray-900">${formatCurrency(driver.total_earnings)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Выручка сегодня:</span>
                                <span class="text-sm font-semibold text-gray-900">${formatCurrency(driver.today_earnings)}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('driverDetailsContent').innerHTML = html;
                document.getElementById('viewDriverModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading driver details:', error);
                showAlert('Ошибка загрузки данных водителя', 'error');
            }
        }

        async function viewPassengerDetails(userId) {
            try {
                const response = await axios.get(`/api/admin/passenger/${userId}`);
                const user = response.data;
                
                if (!user) {
                    showAlert('Пользователь не найден!', 'error');
                    return;
                }
                
                let html = `
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">ID пользователя:</span>
                                    <span class="text-sm text-gray-900">${user.user_id}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Username:</span>
                                    <span class="text-sm text-gray-900">@${user.username || 'не указан'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Имя:</span>
                                    <span class="text-sm text-gray-900">${user.first_name || 'Не указано'}</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Роль:</span>
                                    <span class="text-sm text-gray-900">${getRoleText(user.role)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Статус:</span>
                                    <span class="text-sm ${user.is_banned ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold'}">
                                        ${user.is_banned ? 'Заблокирован' : 'Активен'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm font-medium text-gray-500">Дата регистрации:</span>
                                    <span class="text-sm text-gray-900">${formatDateTime(user.registration_date)}</span>
                                </div>
                            </div>
                        </div>
                        ${user.is_banned ? `
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-500">Причина блокировки:</span>
                                <span class="text-sm text-gray-900">${user.ban_reason || 'Не указана'}</span>
                            </div>
                            <div class="flex justify-between mt-2">
                                <span class="text-sm font-medium text-gray-500">Блокировка до:</span>
                                <span class="text-sm text-gray-900">${user.ban_until ? formatDateTime(user.ban_until) : 'Не указано'}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                if (user.orders && user.orders.length > 0) {
                    html += `
                        <div class="bg-white rounded-lg border border-gray-200">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                    <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                                    История заказов (${user.orders.length})
                                </h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID заказа</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Маршрут</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Стоимость</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    
                    user.orders.forEach(order => {
                        const statusClass = `status-${order.status}`;
                        const statusText = getStatusText(order.status);
                        
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.order_id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.from_location} → ${order.to_location}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(order.price)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${statusText}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateTime(order.created_at)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table></div>`;
                } else {
                    html += `
                        <div class="bg-white rounded-lg border border-gray-200 p-8 text-center">
                            <i data-lucide="package" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-500">Заказов не найдено</p>
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                document.getElementById('passengerDetailsContent').innerHTML = html;
                document.getElementById('viewPassengerModal').classList.remove('hidden');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading passenger details:', error);
                showAlert('Ошибка загрузки данных пассажира', 'error');
            }
        }

        function viewUserDetails(userId) {
            viewPassengerDetails(userId);
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Не указано';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }

        function getStatusText(status) {
            const statusMap = {
                'completed': 'Выполнен',
                'canceled': 'Отменен',
                'searching': 'Поиск водителя',
                'accepted': 'Принят',
                'waiting': 'Ожидание'
            };
            return statusMap[status] || status;
        }

        function getRoleText(role) {
            const roleMap = {
                'user': 'Пользователь',
                'driver': 'Водитель',
                'admin': 'Администратор'
            };
            return roleMap[role] || role;
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `mb-4 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
                'bg-red-100 text-red-800 border border-red-200'
            }`;
            alert.innerHTML = `
                <div class="flex items-center gap-2">
                    <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i>
                    <span>${message}</span>
                </div>
            `;
            alertContainer.appendChild(alert);
            lucide.createIcons();
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showTopDrivers(topDrivers) {
            let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Выручка</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Заказы</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            topDrivers.forEach(driver => {
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${driver.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(driver.total_earnings)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${driver.completed_orders} выполнено</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@${driver.username || 'не указан'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('top-drivers-list').innerHTML = html;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('[id$="Modal"]');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }

        // Initialize the first tab
        showTab('overview');
    </script>
</body>
</html>